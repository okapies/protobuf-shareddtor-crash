# Protobuf `SharedDtor` Crash
To reproduce https://github.com/protocolbuffers/protobuf/issues/435.

## Setup
`onnx.pb.cc` is generated by protoc 2.6.1. I added `printf`s for debugging.

1. Download source code of `protobuf` and build it

```
$ curl -LO https://github.com/google/protobuf/releases/download/v2.6.1/protobuf-2.6.1.tar.gz
$ tar xvf protobuf-2.6.1.tar.gz
$ cd protobuf-2.6.1
$ ./configure --prefix=/home/<user>/protobuf-2.6.1 CFLAGS=-fPIC CXXFLAGS=-fPIC
$ make
$ make install
```

2. Clone the repository and copy `protobuf` to `include/` and `lib/` directory

```
$ git clone https://github.pfidev.jp/okamoto/protobuf-shareddtor.git
$ cd protobuf-shareddtor
$ cp -r ~/protobuf-2.6.1/include/google protobuf-shareddtor/include
$ cp -r ~/protobuf-2.6.1/lib/libprotobuf.* protobuf-shareddtor/lib
```

3. Build and run the reproduction code

```
$ export LD_LIBRARY_PATH=/<somewhere>/protobuf-shareddtor-crash
$ mkdir -p build
$ cd build/
$ cmake ..
$ ./myapp
```

## Result
```
$ ./myapp 
### Starting: ModelProto::SharedCtor() (0x11c70e0)
### Finishing: ModelProto::SharedCtor() (0x11c70e0)
### Starting: ModelProto::SharedCtor() (0x11cf320)
### Finishing: ModelProto::SharedCtor() (0x11cf320)
# Invoking: foo::new_onnx_model()
## Starting: onnx::ModelProto::new_onnx_model()
### Starting: ModelProto::SharedCtor() (0x7ffd1cfaa250)
### Finishing: ModelProto::SharedCtor() (0x7ffd1cfaa250)
## Finishing: onnx::ModelProto::new_onnx_model() (onnx::ModelProto is 0x7ffd1cfaa250)
## GetEmptyStringAlreadyInited in libfoo.so is 0x11c3260
# Finished: foo::new_onnx_model() (onnx::ModelProto is 0x7ffd1cfaa250)
producer_name: 
### Starting: ModelProto::SharedDtor() (0x7ffd1cfaa250)
### GetEmptyStringAlreadyInited() is 0x11cbfb0
### Deleting: producer_name_ (0x7ffd1cfaa250)
### Deleting: producer_version_ (0x7ffd1cfaa250)
*** Error in `./myapp': double free or corruption (out): 0x00000000011c9ae0 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f0f106af7e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7f0f106b837a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7f0f106bc53c]
./myapp(_ZN4onnx10ModelProto10SharedDtorEv+0x181)[0x42d797]
./myapp(_ZN4onnx10ModelProtoD1Ev+0x24)[0x42d59c]
./myapp(main+0xde)[0x451347]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f0f10658830]
./myapp(_start+0x29)[0x422449]
======= Memory map: ========
...
```

## Discussion
As pointed out by [protocolbuffers/protobuf#435](https://github.com/protocolbuffers/protobuf/issues/435), `GetEmptyStringAlreadyInited()` points to different address between `libfoo.so` and `myapp`. protobuf in `myapp` tries to delete `producer_name_` and `producer_version_` even if their actual value is GetEmptyStringAlreadyInited() allocated in `libfoo.so`.

```cpp
void ModelProto::SharedCtor() {
  ::google::protobuf::internal::GetEmptyString();
  ...
  producer_name_ = const_cast< ::std::string*>(&::google::protobuf::internal::GetEmptyStringAlreadyInited());
  producer_version_ = const_cast< ::std::string*>(&::google::protobuf::internal::GetEmptyStringAlreadyInited());
  ...
}

void ModelProto::SharedDtor() {
  if (producer_name_ != &::google::protobuf::internal::GetEmptyStringAlreadyInited()) {
    delete producer_name_;
  }
  if (producer_version_ != &::google::protobuf::internal::GetEmptyStringAlreadyInited()) {
    delete producer_version_;
  }
  ...
```
